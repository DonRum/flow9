var SERVICE_WORKER_VERSION=16,CACHE_NAME="flow-cache",CACHE_NAME_DYNAMIC="flow-dynamic-cache",rangeResourceCache="flow-range-cache",SHARED_DATA_ENDPOINT="share/pwa/data.php",dynamicResourcesExtensions=[".php",".serverbc",".html",".js"],CacheMode={PreferCachedResources:!1,CacheStaticResources:!0,UseOnlyCacheInOffline:!1},requestsSkipOnFetch=[],requestsCacheFilterSimple=[],requestsCacheFilterExternal=[],requestsCount={fromNetwork:0,fromCache:0,skipped:0,failed:0},isOnline=!0;function checkOnlineStatus(){!1===navigator.onLine?(isOnline&&console.info("Application switched to OFFLINE mode."),isOnline=!1):(!isOnline&&console.info("Application returned back to ONLINE mode."),isOnline=!0)}function initializeCacheStorage(){return caches.open(CACHE_NAME).then(function(){return console.log("Opened cache"),Promise.resolve()})}function isEmpty(a){return"undefined"==typeof a||null===a||"string"==typeof a&&""==a||Array.isArray(a)&&0==a.length||"object"==typeof a&&0==Object.keys(a).length}var urlAddBaseLocation=function(a){var b=self.location.href,c=b.lastIndexOf("/");return-1!=c&&(b=b.substr(0,c+1)),a.startsWith("./")&&(a=b+a.substr(1,a.length-1)),a.replace(/(^|[^:])[/]{2,}/,"$1/",a)},extractUrlParameters=function(a){var b=a.split("?");if(1<b.length){var c=b.slice(1).join("&").split("&");return 1!=c.length||c[0].includes("=")||c.unshift("special_case_key=special_case_value"),{baseUrl:b[0],parameters:c}}return{baseUrl:a,parameters:[]}},filterUrlParameters=function(a,b){var c=extractUrlParameters(a);return 0==c.parameters.length?a:c.baseUrl+"?"+c.parameters.filter(function(a){a=a.toLowerCase();var c=a.indexOf("=");return-1!==c&&(a=a.substr(0,c)),!b.includes(a)}).join("&")},sendMessageToClient=function(a,b){a.clientId&&setTimeout(function(){clients.get(a.clientId).then(function(a){isEmpty(a)||a.postMessage(b)})},5)},cleanServiceWorkerCache=function(){return caches.delete(rangeResourceCache),console.log("cache cleared",rangeResourceCache),caches.keys().then(function(a){return Promise.all(a.map(function(a){if(CACHE_NAME!=a&&SHARED_DATA_ENDPOINT!=a)return console.log("cache cleared",a),caches.delete(a)}))})};self.addEventListener("install",function(a){self.skipWaiting(),a.waitUntil(initializeCacheStorage())}),self.addEventListener("activate",function(a){cleanServiceWorkerCache(),a.waitUntil(clients.claim())}),self.addEventListener("fetch",function(a){function b(b,c){return b.isFileUploading?Promise.reject():caches.match(r(b),{ignoreSearch:c&&!b.isCustomCaching}).then(function(c){return c?(requestsCount.fromCache++,sendMessageToClient(a,{msg:"Responded with cache:",url:b.originalRequest.url,urlCached:b.urlNewToCache}),c.clone()):Promise.reject()})}function c(a){return v().then(function(){return b(a,!0)}).catch(function(){return b(a,!1)})}function d(b,d){var e=function(c){var d=r(b);(b.isCustomCaching||b.isStaticCaching||b.isAppMainRequest)&&caches.open(b.usedCacheName).then(function(e){e.put(d,c.clone()),sendMessageToClient(a,{msg:"Cached resource:",url:b.originalRequest.url,urlCached:d.url})})},f=function(){return fetch(b.cloneRequest()).then(function(a){return 200==a.status&&"basic"==a.type&&(u(b.originalRequest.url)&&t(b.originalRequest.url),e(a)),requestsCount.fromNetwork++,a.clone()}).catch(function(){return requestsCount.failed++,Promise.reject()})};return b.isFileUploading?fetch(b.cloneRequest()).then(function(a){return requestsCount.fromNetwork++,a.clone()}):d?c(b).then(function(a){var c=a.headers.get("etag");return isEmpty(c)?f():s(b,c).then(function(b){return fetch(b).then(function(b){return 200==b.status&&"basic"==b.type?(e(b),b.clone()):304==b.status&&"basic"==b.type?a.clone():b.clone()})}).catch(f)}).catch(f):f()}function e(a){return CacheMode.UseOnlyCacheInOffline&&!isOnline?c(a).catch(function(){return requestsCount.failed++,Promise.reject()}):CacheMode.PreferCachedResources?c(a).catch(function(){return d(a,!1)}):d(a,!0).catch(function(){return c(a).catch(function(){return requestsCount.failed++,Promise.reject()})})}function f(a){return caches.match(a.urlNewToCache).then(function(b){return b||CacheMode.UseOnlyCacheInOffline&&!0!==navigator.onLine?b:fetch(a.originalRequest).then(function(b){if(200==b.status){var c=b.clone();return caches.open(rangeResourceCache).then(function(b){return b.put(r(a),c)}).then(function(){return b})}return b})}).then(function(b){return 200==b.status?b.arrayBuffer().then(function(c){var d=/^bytes\=(\d+)\-(\d+)?$/g.exec(a.originalRequest.headers.get("range"));if(d){var e=+d[1],f=+d[2]||c.byteLength-1;return new Response(c.slice(e,f+1),{status:206,statusText:"Partial Content",headers:[["Content-Type",b.headers.get("Content-Type")],["Content-Range","bytes "+e+"-"+f+"/"+c.byteLength]]})}return new Response(null,{status:416,statusText:"Range Not Satisfiable",headers:[["Content-Range","*/"+c.byteLength]]})}):b})}function g(b,c){return function(){return null==c?m(b).then(function(c){var d=n(c.urlNewFull,b.method,!1),e=c.urlNewFull,f=CACHE_NAME;return isEmpty(d)||(d.isSimple?(e=filterUrlParameters(e,d.ignoreKeys),f=CACHE_NAME_DYNAMIC):(!isEmpty(d.onNewUrlString)&&(e=d.onNewUrlString(b,e)),e=filterUrlParameters(e,d.ignoreKeys),f="flow-"+d.name+"-cache")),{urlNewFull:c.urlNewFull,urlNewToCache:e,isCustomCaching:!isEmpty(d),isStaticCaching:j(a.request.url),isAppMainRequest:k(b.url),customCacheFilter:d,originalRequest:b,isFileUploading:c.isFileUploading,usedCacheName:f,cloneRequest:function(){return b.clone()}}}):Promise.resolve(c)}().then(function(a){return a.originalRequest.headers.get("range")?f(a):e(a)})}var h=function(a){var b=urlAddBaseLocation(a.url).toLowerCase(),c=a.method.toLowerCase();return!isEmpty(requestsSkipOnFetch.find(function(d){return!!(isEmpty(d.url)||b.startsWith(d.url))&&!isEmpty(d.methods.find(function(b){return!!(isEmpty(b.method)||b.method==c)&&!isEmpty(b.headers.find(function(b){return isEmpty(b.key)||a.headers.has(b.key)&&a.headers.get(b.key)==b.value}))}))}))},i=function(a){if("POST"==a.method&&a.headers.has("Content-Type")){var b=a.headers.get("Content-Type").toLowerCase(),c=a.headers.get("Content-Length");return b.includes("multipart/form-data")&&b.includes("boundary=")||1e4<c}return!1},j=function(){var a,b=new URL(x.url).pathname,c=1<(a=b.split("/").pop().split(".")).length?a.pop():"";return CacheMode.CacheStaticResources&&!isEmpty(c)&&!dynamicResourcesExtensions.includes("."+c)},k=function(){var a,b=new URL(x.url).pathname,c=1<(a=b.split("/").pop().split(".")).length?a.pop():"",d=0<a.length?a.pop():"",e=!isEmpty(c)&&!isEmpty(d)&&("stamp.php"==d+"."+c||"flowjs.html"==d+"."+c);return e&&(requestsCount.fromNetwork=0,requestsCount.fromCache=0,requestsCount.skipped=0,requestsCount.failed=0),e},l=function(a){var b=urlAddBaseLocation(a.url),c=extractUrlParameters(b),d=c.baseUrl,e=CACHE_NAME;if("GET"==a.method){var f=n(b,a.method,!1),g=b;return isEmpty(f)||(f.isSimple?(g=filterUrlParameters(b,f.ignoreKeys),e=CACHE_NAME_DYNAMIC):(!isEmpty(f.onNewUrlString)&&(b=f.onNewUrlString(a,b)),g=filterUrlParameters(b,f.ignoreKeys),e="flow-"+f.name+"-cache")),{urlNewFull:b,urlNewToCache:g,isCustomCaching:!isEmpty(f),isStaticCaching:j(a.url),isAppMainRequest:k(a.url),customCacheFilter:f,originalRequest:a,isFileUploading:i(a),usedCacheName:e,cloneRequest:function(){return a.clone()}}}return null},m=function(a){var b=urlAddBaseLocation(a.url),c=extractUrlParameters(b),d=c.baseUrl,e="?",f=i(a);return"POST"==a.method?f?Promise.resolve({urlNewFull:b,isFileUploading:f}):(0!=c.parameters.length&&(d+=e+c.parameters.join("&"),e="&"),a.clone().text().then(function(a){return isEmpty(a)||(d+=e+a),{urlNewFull:d,isFileUploading:f}}).catch(function(){return{urlNewFull:b,isFileUploading:f}})):Promise.resolve({urlNewFull:b,isFileUploading:f})},n=function(a,b,c){a=a.toLowerCase(),b=b.toLowerCase();var d=extractUrlParameters(a).parameters,e=o(a,b,d,c);return isEmpty(e)||!(0<e.length)||isEmpty(e[0])?(e=p(a,b,d,c),isEmpty(e)||!(0<e.length)||isEmpty(e[0])?void 0:e[0]):e[0]},o=function(a,b,c,d){return requestsCacheFilterExternal.map(function(e){return e.filters.map(function(f){return""==f.url||a.startsWith(f.url.toLowerCase())?(methods=f.methods.map(function(a){if(""==a.method||a.method.toLowerCase()==b){if(0==a.parameters.length||d)return[{method:a.method,parameters:[],ignoreKeys:[],isSimple:!1,name:e.name,onNewUrlString:a.onNewUrlStringDefault}];var f=function(a){return a.keyValues.every(function(a){var b=a.key+"="+a.value;return-1!=c.findIndex(function(a){return b==a})})};return a.parameters.filter(function(a){return 0==a.keyValues.length||f(a)}).map(function(b){return{method:a.method,parameters:b.keyValues,ignoreKeys:b.ignoreKeys,isSimple:!1,name:e.name,onNewUrlString:b.onNewUrlString}})}}).filter(function(a){return null!=a}).flat(),0<methods.length?methods.map(function(a){return{url:f.url,method:a.method,parameters:a.parameters,ignoreKeys:a.ignoreKeys,isSimple:!1,name:a.name,onNewUrlString:a.onNewUrlString}}):void 0):void 0}).filter(function(a){return null!=a}).flat()}).filter(function(a){return null!=a}).flat()},p=function(a,b,c,d){return requestsCacheFilterSimple.map(function(e){return""==e.url||a.startsWith(e.url)?(methods=e.methods.map(function(a){if(""==a.method||a.method==b){if(0==a.parameters.length||d)return[{method:a.method,parameters:[],ignoreKeys:[],isSimple:!0,name:""}];var e=function(a){return a.keyValues.every(function(a){var b=a.key+"="+a.value;return-1!=c.findIndex(function(a){return b==a})})};return a.parameters.filter(function(a){return 0==a.keyValues.length||e(a)}).map(function(b){return{method:a.method,parameters:b.keyValues,ignoreKeys:b.ignoreKeys,isSimple:!0,name:""}})}}).filter(function(a){return null!=a}).flat(),0<methods.length?methods.map(function(a){return{url:e.url,method:a.method,parameters:a.parameters,ignoreKeys:a.ignoreKeys,isSimple:!0,name:""}}):void 0):void 0}).filter(function(a){return null!=a}).flat()},q=function(a){var b=urlAddBaseLocation(a.url);return n(b,a.method,!0)},r=function(a){if(a.isCustomCaching||a.urlNewToCache!=a.originalRequest.url){var b=a.cloneRequest();return new Request(a.urlNewToCache,{method:"GET",headers:b.headers,mode:"same-origin",credentials:b.credentials,cache:b.cache,redirect:b.redirect,referrer:b.referrer,integrity:b.integrity})}if(a.isAppMainRequest){var b=a.cloneRequest();return new Request(extractUrlParameters(a.urlNewToCache).baseUrl,{method:"GET",headers:b.headers,mode:"same-origin",credentials:b.credentials,cache:b.cache,redirect:b.redirect,referrer:b.referrer,integrity:b.integrity})}return a.cloneRequest()},s=function(a,b){var c=a.cloneRequest(),d=new Headers;return c.headers.forEach(function(a,b){d.set(b,a)}),d.set("If-None-Match",b),d.set("X-If-None-Match",b),"POST"==c.method?c.blob().then(function(a){return new Request(c.url,{method:c.method,headers:d,body:a,mode:"same-origin",credentials:c.credentials,cache:c.cache,redirect:c.redirect,referrer:c.referrer,integrity:c.integrity})}).catch(function(){return new Request(c.url,{method:c.method,headers:d,mode:"same-origin",credentials:c.credentials,cache:c.cache,redirect:c.redirect,referrer:c.referrer,integrity:c.integrity})}):Promise.resolve(new Request(c.url,{method:c.method,headers:d,mode:"same-origin",credentials:c.credentials,cache:c.cache,redirect:c.redirect,referrer:c.referrer,integrity:c.integrity}))},t=function(a){var b=new URL(a);return v().then(function(){return caches.open(CACHE_NAME).then(function(a){return a.delete(self.registration.scope+"php/stamp.php",{ignoreSearch:!0}).then(function(){return a.delete(self.registration.scope+b.searchParams.get("file"),{ignoreSearch:!0})})})}).catch(function(){return null})},u=function(b){if(!a.clientId)return!1;var c=new URL(b);return c.pathname.endsWith("/php/stamp.php")&&!isEmpty(c.searchParams.get("file"))},v=function(){if(!a.clientId)return Promise.reject();new URL(a.request.url);return clients.get(a.clientId).then(function(a){new URL(a.url);return u(a.url)?Promise.resolve():Promise.reject()})},w=function(a,b){return h(a)||i(a)||!isEmpty(a.headers.get("range"))&&!0===navigator.onLine||!j(a.url)&&!k(a.url)&&(isEmpty(b)||!b.isCustomCaching)&&isEmpty(q(a))&&!u(a.url)};const{request:x,request:{url:y,method:z}}=a;if(checkOnlineStatus(),y.match(SHARED_DATA_ENDPOINT))a.respondWith(caches.open(SHARED_DATA_ENDPOINT).then(a=>"POST"==z?x.json().then(b=>(a.put(SHARED_DATA_ENDPOINT+"/"+b.key,new Response(b.value)),new Response("OK"))):a.match(SHARED_DATA_ENDPOINT+"/"+new URL(x.url).searchParams.get("key")).then(a=>a||new Response(""))||new Response("")));else{var A=l(a.request);if(w(a.request,A))return void requestsCount.skipped++;a.respondWith(g(a.request,A))}}),self.addEventListener("message",function(a){var b=function(b){0<a.ports.length?a.ports[0].postMessage(b):console.error("ServiceWorker: Failed to respond!")},c=function(a){a.then(function(){b({status:"OK"})}).catch(function(){b({status:"Failed"})})},d=function(b,c){var d=new Request(urlAddBaseLocation(b));return fetch(d).then(function(e){if(200==e.status&&"basic"==e.type){var f=new Request(filterUrlParameters(d.url,c.map(function(a){return a.toLowerCase()})));caches.open(CACHE_NAME_DYNAMIC).then(function(c){return c.put(f,e.clone()),sendMessageToClient(a,{msg:"Cached resource:",url:b,urlCached:f.url}),!0}).catch(function(){return!1})}else return!1}).catch(function(){return!1})},e=function(a,b){return isEmpty(a)&&isEmpty(b)||a===b},f=function(a){return isEmpty(a)?"":a};if("add_dynamic_resource_extension"==a.data.action)a.data.data.value=(a.data.data.value.startsWith(".")?a.data.data.value.substr(1):a.data.data.value).toLowerCase(),dynamicResourcesExtensions.includes("."+a.data.data.value)||dynamicResourcesExtensions.push("."+a.data.data.value),b({status:"OK"});else if("remove_dynamic_resource_extension"==a.data.action)a.data.data.value=(a.data.data.value.startsWith(".")?a.data.data.value.substr(1):a.data.data.value).toLowerCase(),dynamicResourcesExtensions.includes("."+a.data.data.value)&&(dynamicResourcesExtensions=dynamicResourcesExtensions.filter(b=>b!="."+a.data.data.value)),b({status:"OK"});else if("set_prefer_cached_resources"==a.data.action)CacheMode.PreferCachedResources=a.data.data.value,b({status:"OK"});else if("set_cache_static_resources"==a.data.action)CacheMode.CacheStaticResources=a.data.data.value,b({status:"OK"});else if("get_cache_version"==a.data.action)b({cache_version:SW_CACHE_VERSION});else if(0<a.data.action.indexOf("_cache_resources"))c(caches.open(CACHE_NAME).then(function(b){return Promise.all(a.data.urls.map(function(c){return"add_cache_resources"==a.data.action?b.add(c):"remove_cache_resources"==a.data.action?b.delete(c):void 0}))}));else if("get_cache_storage_names"==a.data.action)caches.keys().then(function(a){b({names:a})});else if("remove_cache_storage"==a.data.action)c(caches.delete(a.data.action.name));else if("clean_cache_storage"==a.data.action)c(cleanServiceWorkerCache());else if("requests_cache_filter"==a.data.action){a.data.data.cacheIfUrlMatch=urlAddBaseLocation(a.data.data.cacheIfUrlMatch).toLowerCase(),a.data.data.method=a.data.data.method.toLowerCase(),a.data.data.ignoreParameterKeysOnCache=a.data.data.ignoreParameterKeysOnCache.map(function(a){return a.toLowerCase()});var g=requestsCacheFilterSimple.findIndex(function(b){return e(a.data.data.cacheIfUrlMatch,b.url)});-1==g&&(requestsCacheFilterSimple.push({url:f(a.data.data.cacheIfUrlMatch),methods:[]}),g=requestsCacheFilterSimple.length-1);var h=requestsCacheFilterSimple[g].methods.findIndex(function(b){return e(a.data.data.method,b.method)});-1==h&&(requestsCacheFilterSimple[g].methods.push({method:f(a.data.data.method),parameters:[]}),h=requestsCacheFilterSimple[g].methods.length-1);var i=requestsCacheFilterSimple[g].methods[h].parameters.findIndex(function(b){return!(b.keyValues.length!=a.data.data.cacheIfParametersMatch.length)&&a.data.data.cacheIfParametersMatch.every(function(a){return 2==a.length&&-1!=b.keyValues.findIndex(function(b){return e(b.key,a[0])&&e(b.value,a[1])})})});-1==i?requestsCacheFilterSimple[g].methods[h].parameters.push({keyValues:a.data.data.cacheIfParametersMatch.map(function(a){return{key:a[0],value:a[1]}}),ignoreKeys:a.data.data.ignoreParameterKeysOnCache}):requestsCacheFilterSimple[g].methods[h].parameters[i]={keyValues:a.data.data.cacheIfParametersMatch.map(function(a){return{key:a[0],value:a[1]}}),ignoreKeys:a.data.data.ignoreParameterKeysOnCache},b({status:"OK"})}else if("requests_skip_filter"==a.data.action){a.data.data.url=urlAddBaseLocation(a.data.data.url).toLowerCase(),a.data.data.method=a.data.data.method.toLowerCase(),a.data.data.header=a.data.data.header.map(function(a){return a.toLowerCase()}),a.data.data.header=2==a.data.data.header.length?{key:a.data.data.header[0],value:a.data.data.header[1]}:{key:"",value:""};var g=requestsSkipOnFetch.findIndex(function(b){return e(a.data.data.url,b.url)});-1==g&&(requestsSkipOnFetch.push({url:f(a.data.data.url),methods:[]}),g=requestsSkipOnFetch.length-1);var h=requestsSkipOnFetch[g].methods.findIndex(function(b){return e(a.data.data.method,b.method)});-1==h&&(requestsSkipOnFetch[g].methods.push({method:f(a.data.data.method),headers:[]}),h=requestsSkipOnFetch[g].methods.length-1);var i=requestsSkipOnFetch[g].methods[h].headers.findIndex(function(b){return e(b.key,a.data.data.header.key)&&e(b.value,a.data.data.header.value)});-1==i&&requestsSkipOnFetch[g].methods[h].headers.push(a.data.data.header),b({status:"OK"})}else"load_and_cache_urls"==a.data.action?c(Promise.all(a.data.data.urls.map(function(b){return d(b,a.data.data.ignoreParameterKeysOnCache)}))):"check_urls_in_cache"==a.data.action?function(a){return Promise.all(a.map(function(a){return caches.match(urlAddBaseLocation(a),{ignoreSearch:!1}).then(function(b){return b?a:""}).catch(function(){return""})})).then(function(a){return a.filter(function(a){return""!=a})}).then(function(a){return{urls:a,status:"OK"}}).catch(function(){return{urls:[],status:"Failed"}})}(a.data.data.urls).then(b):"get_service_worker_version"==a.data.action?b({data:SERVICE_WORKER_VERSION}):"set_use_cache_only_in_offline"==a.data.action?(CacheMode.UseOnlyCacheInOffline=a.data.enabled,b({status:"OK"})):"get_requests_stats"==a.data.action?b({data:requestsCount}):b({status:"Failed",error:"Unknown operation: "+a.data.action})});