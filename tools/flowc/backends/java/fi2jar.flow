import sys/system;
import tools/flowc/backends/common;

export {
	buildFiJarFile(cfg : FiJavaConfig, path : string, callback : () -> void) -> void;
}

// native startProcess : io (
//	command : string, 
//	args : [string], 
//	currentWorkingDirectory : string, 
//	stdin : string, 
//	onExit : (errorcode : int, stdout : string, stderr : string
//
// ) -> void) -> void = Native.startProcess;

buildFiJarFile(cfg : FiJavaConfig, path : string, callback : () -> void) -> void {
	jar = changeFileExt(cfg.jarfile, ".jar");
	println("\"%JAVA_HOME%\\bin\\javac\" -Xlint:unchecked -encoding UTF-8 -cp platforms/java " + path + "/*.java");
	println("\"%JAVA_HOME%\\bin\\jar\" cf " + jar + " -C platforms/java com/area9innovation/flow/");
	println("\"%JAVA_HOME%\\bin\\jar\" feu " + jar + " com.area9innovation.flow.Main -C " + cfg.outputdir + " com/area9innovation/flow");
	println("Run with \"java -jar " + jar + "\"");

	flowdir = rtrim2(getFlowDir(), "/");
	package_path = pathCombineMany(concat([cfg.outputdir], strSplit(cfg.packageName, ".")));
	
	println("flowdir: " + flowdir);
	println("package_path: " + package_path);
	println("getApplicationPath: " + getApplicationPath());
	br = \s -> "\"" + s + "\"";

	build_jar = \-> {
		fcPrintln("Building a jar file");
		fcPrintln("command:");
		args = ["cfe", jar, "com.area9innovation.flow.Main", "com/area9innovation/flow/*.class" ,"-C", flowdir + "/platforms/java", "com/area9innovation/flow/"];
		fcPrintln("jar " + strGlue(args, " "));
		startProcess(
			"jar", 
			args, 
			"javagen", 
			"", 
			\errcode, stdout, stderr -> {
				if (stdout != "") fcPrintln(stdout);
				if (stderr != "") fcPrintln(stderr);
				if (errcode == 0) {
					fcPrintln("Run with \"java -jar " + jar + "\"");
				}
				callback()
			} 
		)
	}

	compile_java = \ -> {
		fcPrintln("Compiling the generated code");
		fcPrintln("command:");
		args = ["-Xlint:unchecked", "-encoding", "UTF-8", "-cp",   flowdir + "/platforms/java:javagen" + ,  "@"/ + path + "/sources"];
		fcPrintln("javac " + strGlue(args, " "));
		startProcess(
			"javac", 
			args, 
			".", 
			"", 
			\errcode, stdout, stderr -> {
				if (stdout != "") fcPrintln(stdout);
				if (stderr != "") fcPrintln(stderr);
				if (errcode == 0) {
					build_jar()
				} else {
					callback()
				}
			}
		)
	}
	compile_runtime = \ -> {
		fcPrintln("Compiling the runtime");
		fcPrintln("command:");
		command = "javac";
		args = ["-Xlint:unchecked", "-encoding", "UTF-8", "-cp",   flowdir + "/platforms/java" + ,  "@"/ + path + "/sources"];
		fcPrintln(command + " " + strGlue(args, " "));
		startProcess(
			command, 
			args, 
			".", 
			"", 
			\errcode, stdout, stderr -> {
				if (stdout != "") fcPrintln(stdout);
				if (stderr != "") fcPrintln(stderr);
				if (errcode == 0) {
					build_jar()
				} else {
					callback()
				}
			}
		)
	}

	compile_java();
}
