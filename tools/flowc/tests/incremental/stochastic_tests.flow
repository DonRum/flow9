import sys/system;
import ds/simplegraph;
import tools/flowc/incremental/fi2flowsrc;
import tools/flowc/incremental/fiprogram;
import tools/flowc/tests/incremental/stochastic_env;
import tools/flowc/tests/incremental/stochastic_gen;

mutateModulesCorrectly(generated : GenModules) -> void {
	ind = randomInt(length(generated.modules));
	module = ^(generated.modules[ind]);
	if (length(module.structs) > 0) {
		// A struct module
		struct = module.structs[0];
		choice = randomInt(4);
		if (choice == 0) {
			// add a field
			addAStructField(ind, struct, generated);
		} else if (choice == 1) {
			// delete a field 
		} else if (choice == 2) {
			// rename a field
		} else if (choice == 3) {
			// change field type
		}
	} else if (length(module.unions) > 0) {
		// A union module
		choice = randomInt(2);
		if (choice == 0) {
			// Add a random struct to the union
			
		} else if (choice == 1) {
			// Remove a random struct from the union
			
			
		}
	} else if (length(module.functions) > 0) {
	
	} else if (length(module.globalVars) > 0) {
	
	}
	writeModule(^(generated.modules[ind]));
}

//FiTypeStruct(name : string, typars : [FiType], args : [FiStructArg], start : int);
//		FiStructArg(name : string, type : FiType, ismutable : bool);
//	FiTypeUnion(name : string, typeparameters : [FiType], typenames : [FiTypeName], start : int);

addAStructField(i : int, struct : FiTypeStruct, generated : GenModules) -> void {
	new_field = FiStructArg("f_" + i2s(length(struct.args)), generateType(^(generated.env)), false);
	new_struct = FiTypeStruct(
		struct.name, [], 
		concat(struct.args, [new_field]), -1
	);
	orig_module = ^(generated.modules[i]);
	generated.modules[i] := FiModule(orig_module with structs = [new_struct]);
	modified_inds = foldi(generated.modules, [i],
		\j, acc, modref -> {
			m = ^modref;
			concat(acc, [j])
		}
	)
	iter(modified_inds, \j -> writeModule(^(generated.modules[j])))
}

testCorrectMutation(generated : GenModules, i : int) -> void {
	if (i == 0) {
		println("All tests pass successfully");
		quit(0);
	} else {
		startProcess("flowc1", ["./gen/main.flow"], ".", "", \errcode, stdout, stderr -> {
			if (errcode != 0) {
				println("ERROR STDOUT: ");
				println(stdout);
				println("ERROR STDERR: ");
				println(stderr);
				quit(-1);
			} else {
				println("test iteration: " + i2s(i) + " passed successfully");
				mutateModulesCorrectly(generated);
				testCorrectMutation(generated, i - 1);
			}
		});
	}
}

writeModule(module : FiModule) -> void {
	src = fimodule2flowsrc(module);
	ensureDirectoryExists(dirName(module.fileinfo.fullpath));
	setFileContent(module.fileinfo.fullpath, src);
	{}
}

main() {
	println("Stochastic tests of incremental compilation");
	println("");
	
	deleteDirectory("./gen");
	
	item_count = s2i(getUrlParameterDef("items", "100"));
	mod_count = s2i(getUrlParameterDef("modules", "100"));
	iterations = s2i(getUrlParameterDef("iterations", "10"));
	
	//m = generateIncrementalTestModule(mod_count);
	//writeModule(m);
	//println("module '" + m.fileinfo.fullpath + "' is written");
	
	generated = generateIncrementalTestModules(mod_count);
	iter(generated.modules, \module -> writeModule(^module));

	fcPrintln("correct mutations...");
	testCorrectMutation(generated, iterations);
}
